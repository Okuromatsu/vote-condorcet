{% extends 'voting/base.html' %}
{% load i18n %}

{% block title %}{% trans "Creator Dashboard" %} - Condorcet Vote{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1>ğŸ‘¤ {% trans "Creator Dashboard" %}</h1>
            <p class="text-muted">{% trans "Manage your polls with creator code:" %} <code>{{ creator_code }}</code></p>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-secondary" onclick="copyCreatorCode()">
                ğŸ“‹ {% trans "Copy Code" %}
            </button>
        </div>
    </div>

    <!-- Tabs: All / Active / Closed -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" href="#all" data-bs-toggle="tab">
                {% trans "All Polls" %} ({{ polls_data|length }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#active" data-bs-toggle="tab">
                {% trans "Active" %}
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#closed" data-bs-toggle="tab">
                {% trans "Closed" %}
            </a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- All Polls Tab -->
        <div class="tab-pane fade show active" id="all">
            {% if polls_data %}
                <div class="row">
                    {% for item in polls_data %}
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header {% if item.poll.is_active %}bg-success{% else %}bg-secondary{% endif %} text-white">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title mb-1">{{ item.poll.title }}</h5>
                                        <small>{% trans "Created:" %} {{ item.poll.created_at|date:"M d, Y H:i" }}</small>
                                    </div>
                                    <div class="text-end">
                                        {% if item.poll.is_public %}
                                            <span class="badge bg-warning">{% trans "Public" %}</span>
                                        {% else %}
                                            <span class="badge bg-dark">{% trans "Private" %}</span>
                                        {% endif %}
                                        {% if item.poll.is_active %}
                                            <span class="badge bg-info">{% trans "Open" %}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{% trans "Closed" %}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="card-body">
                                <!-- Poll Stats -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">{% trans "Votes Cast" %}</small>
                                        <h4 class="mb-0">{{ item.vote_count }}</h4>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">{% trans "Candidates" %}</small>
                                        <h4 class="mb-0">{{ item.candidates_count }}</h4>
                                    </div>
                                </div>

                                <!-- Current Winner -->
                                {% if item.winner %}
                                <div class="alert alert-info mb-3">
                                    <small>ğŸ† {% trans "Current Leader:" %} <strong>{{ item.winner.name }}</strong></small>
                                </div>
                                {% elif item.vote_count == 0 %}
                                <div class="alert alert-warning mb-3">
                                    <small>â³ {% trans "No votes yet" %}</small>
                                </div>
                                {% endif %}

                                <!-- Poll Description -->
                                {% if item.poll.description %}
                                <p class="text-muted small mb-3">{{ item.poll.description }}</p>
                                {% endif %}

                                <!-- Candidates List -->
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-2">{% trans "Candidates:" %}</small>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for candidate in item.poll.candidate_set.all %}
                                        <span class="badge bg-light text-dark">{{ candidate.name }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="card-footer bg-light">
                                <div class="btn-group w-100" role="group">
                                    <a href="{% url 'voting:results_poll' item.poll.id %}" class="btn btn-sm btn-outline-info">
                                        ğŸ“Š {% trans "Results" %}
                                    </a>
                                    {% if item.poll.is_active %}
                                    <a href="{% url 'voting:vote_poll' item.poll.id %}" class="btn btn-sm btn-outline-success">
                                        ğŸ—³ï¸ {% trans "Vote" %}
                                    </a>
                                    {% else %}
                                    <button class="btn btn-sm btn-outline-success" disabled>
                                        ğŸ—³ï¸ {% trans "Vote" %}
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" 
                                            data-bs-target="#shareModal" onclick="setSharePoll('{{ item.poll.id }}')">
                                        ğŸ”— {% trans "Share" %}
                                    </button>
                                </div>
                                <div class="btn-group w-100 mt-2" role="group">
                                    {% if item.poll.is_public %}
                                    <a href="?action=make_private&poll_id={{ item.poll.id }}" class="btn btn-sm btn-outline-secondary">
                                        ğŸ”’ {% trans "Make Private" %}
                                    </a>
                                    {% else %}
                                    <a href="?action=make_public&poll_id={{ item.poll.id }}" class="btn btn-sm btn-outline-primary">
                                        ğŸŒ {% trans "Make Public" %}
                                    </a>
                                    {% endif %}
                                    {% if item.poll.is_active %}
                                    <a href="?action=close&poll_id={{ item.poll.id }}" class="btn btn-sm btn-outline-warning">
                                        ğŸ”’ {% trans "Close" %}
                                    </a>
                                    {% else %}
                                    <a href="?action=reopen&poll_id={{ item.poll.id }}" class="btn btn-sm btn-outline-success">
                                        ğŸ”“ {% trans "Reopen" %}
                                    </a>
                                    {% endif %}
                                    <a href="?action=delete&poll_id={{ item.poll.id }}" 
                                       onclick="return confirm('{% trans "Are you sure you want to delete this poll?" %}')"
                                       class="btn btn-sm btn-outline-danger">
                                        ğŸ—‘ï¸ {% trans "Delete" %}
                                    </a>
                                    {% if item.poll.results_released %}
                                    <a href="?action=hide_results&poll_id={{ item.poll.id }}" class="btn btn-sm btn-outline-secondary">
                                        ğŸ‘ï¸â€ğŸ—¨ï¸ {% trans "Hide Results" %}
                                    </a>
                                    {% else %}
                                    <a href="?action=release_results&poll_id={{ item.poll.id }}" class="btn btn-sm btn-outline-secondary">
                                        ğŸ‘ï¸ {% trans "Release Results" %}
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    <h5>{% trans "No polls found" %}</h5>
                    <p>{% trans "You haven't created any polls yet." %} <a href="{% url 'voting:create_poll' %}">{% trans "Create one now!" %}</a></p>
                </div>
            {% endif %}
        </div>

        <!-- Active Polls Tab -->
        <div class="tab-pane fade" id="active">
            {% for item in polls_data %}
                {% if item.poll.is_active and not item.poll.is_deleted %}
                    <p>{{ item.poll.title }} - {{ item.vote_count }} {% trans "votes" %}</p>
                {% endif %}
            {% empty %}
                <p class="text-muted">{% trans "No active polls" %}</p>
            {% endfor %}
        </div>

        <!-- Closed Polls Tab -->
        <div class="tab-pane fade" id="closed">
            {% for item in polls_data %}
                {% if not item.poll.is_active and not item.poll.is_deleted %}
                    <p>{{ item.poll.title }} - {{ item.vote_count }} {% trans "votes" %} - 
                       {% if item.winner %}{% trans "Winner:" %} {{ item.winner.name }}{% endif %}</p>
                {% endif %}
            {% empty %}
                <p class="text-muted">{% trans "No closed polls" %}</p>
            {% endfor %}
        </div>
    </div>

    <!-- Navigation -->
    <div class="mt-4">
        <a href="{% url 'voting:create_poll' %}" class="btn btn-primary">
            â¡ï¸ {% trans "Create New Poll" %}
        </a>
        <a href="{% url 'voting:index' %}" class="btn btn-outline-secondary">
            ğŸ  {% trans "Back to Home" %}
        </a>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Share Poll" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{% trans "Voting Link:" %}</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="shareUrl" readonly>
                        <button class="btn btn-outline-primary" onclick="copyShareUrl()">{% trans "Copy" %}</button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">{% trans "QR Code:" %}</label>
                    <div id="shareQR"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Store site_url in data attribute (safe - not interpolated in JS string)
const SITE_URL = "{{ site_url }}";

function copyCreatorCode() {
    const code = "{{ creator_code }}";
    navigator.clipboard.writeText(code).then(() => {
        alert('{% trans "Creator code copied!" %}');
    });
}

function setSharePoll(pollId) {
    // Build URL safely from data-attribute (not template interpolation)
    const url = SITE_URL + '/vote/' + pollId + '/';
    document.getElementById('shareUrl').value = url;
    document.getElementById('shareQR').innerHTML = 
        `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}" alt="QR Code">`;
}

function copyShareUrl() {
    const url = document.getElementById('shareUrl').value;
    navigator.clipboard.writeText(url).then(() => {
        alert('{% trans "Link copied!" %}');
    });
}
</script>
{% endblock %}
